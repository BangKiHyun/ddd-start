# 애그리거트와 트랜잭션

트랜잭션마다 리포지터리는 새로운 애그리거트 객체를 생성한다. 즉, 개념적으로 동일한 애그리거트지만 물리적으로 서로 다른 애그리거트 객체를 사용하게된다.

다음은 주문 애그리거트에 대해 운영자는 배송 상태로 변경할 때 사용자는 배송지 주소를 변경하는 경우를 시간 순서로 표시한 예다.

![image](https://user-images.githubusercontent.com/43977617/102687858-937bdc00-4235-11eb-988f-fc91384c45a1.png)

이 상황에서 두 스레드는 각각 트랜잭션을 커밋할 때 수정한 내용을 DBMS에 반영한다. 즉, 배송 상태로 바뀌고 배송지 정보도 바뀌게 된다.

여기서 문제점으로 **애그리거트의 일관성이 깨지게된다.** 운영자는 기손 배송지 정보를 이용해서 배송 상태를 변경했는데 그 사이 고객은 배송지 정보를 변경했기 때문이다.

위와 같은 문제를 해결하기 위해 두 가지 방법이 있다.

- 운영자가 배송지 정보를 조회하고 상태를 변경하는 동안 고객이 애그리거트를 수정하지 못하게 막는다. (Pessimistic Lock)
- 운영자가 배송지 정보를 조회한 이후에 고객이 정보를 변경하면 운영자가 애그리거트를 다시 조회한 뒤 수정하도록 한다. (Optimistic Lock)

